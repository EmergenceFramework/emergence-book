
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Migrations Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="skeletons-from-scratch.html" />
    
    
    <link rel="prev" href="make-a-model-searchable-by-tags.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    Development
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../development/getting_started.html">
            
                <a href="../development/getting_started.html">
            
                    
                    Getting Started
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    Deployment
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../deployment/habitat.html">
            
                <a href="../deployment/habitat.html">
            
                    
                    Deploy a Site with Chef Habitat
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../deployment/docker.html">
            
                <a href="../deployment/docker.html">
            
                    
                    Deploy a Site with Docker
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    Guides
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="creating-a-dynamic-page.html">
            
                <a href="creating-a-dynamic-page.html">
            
                    
                    Creating a Dynamic Page
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="make-a-model-searchable-by-tags.html">
            
                <a href="make-a-model-searchable-by-tags.html">
            
                    
                    Make a Model Searchable by Tags
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.4.3" data-path="migrations.html">
            
                <a href="migrations.html">
            
                    
                    Migrations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="skeletons-from-scratch.html">
            
                <a href="skeletons-from-scratch.html">
            
                    
                    Bootstrap a Site from Git
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="translating-sites.html">
            
                <a href="translating-sites.html">
            
                    
                    Translating a Site into Multiple Languages
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="sending-email.html">
            
                <a href="sending-email.html">
            
                    
                    Sending Emails
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Migrations</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="migrations">Migrations</h1>
<p>Migrations are scripts designed to run once on each instance they&apos;re deployed to in the order they were created. They are most useful for transforming database structure but can also be used to check or update configuration or other application customizations.</p>
<h2 id="migrations-state-storage">Migrations state storage</h2>
<p>The status of each migration script is tracked in the <code>_e_migrations</code> table. New scripts have no record in the table and are considered pending and in need of execution. Once started, a migration script cannot be run again without manually resetting its status in the <code>_e_migrations</code> table.</p>
<h2 id="developer-user-interface">Developer user interface</h2>
<p>A user interface is available for Developer+ users online at <code>/site-admin/migrations</code>. From here you can view a list of all <strong>pending</strong>, <strong>started</strong>, <strong>skipped</strong>, <strong>failed</strong>, and <strong>executed</strong> migrations and execute any that are pending.</p>
<h2 id="philosophy">Philosophy</h2>
<p>Migration scripts in emergence don&apos;t have the usually <code>up</code>/<code>down</code> workflow that migration frameworks usually provide. Instead, it is expected that a website/database be snapshotted before migrations are run as this provides a more reliable recovery process in the case of failed migrations. Each script implements only one routine: upgrade if needed. The goal of every migration script is to first check if it can do nothing and return the status <strong>skipped</strong>, and then execute the migration and return the status <strong>executed</strong> or <strong>failed</strong>. A migration should be safe to run multiple times and return <strong>skipped</strong> when it can test that it has been run already.</p>
<p>Migrations should make incremental changes, only changing that which it checked for, such as adding a database column or changing its type. Table schemas can be generated in a number of ways and can be augmented by configuration from other packages, so moving a table to a total known state isn&apos;t the goal.</p>
<h2 id="building-a-migration">Building a migration</h2>
<h3 id="creating-script-file">Creating script file</h3>
<p>Create a new file under the <code>php-migrations</code> tree, placing it under a folder reflecting the highest common PHP namespace of the application/database elements it affects. Each file starts with a datestamp in the format <code>YYYYMMDD</code> which is used to order the execution of migrations. The datestame can optionally further include a time component in the format <code>YYYYMMDDHHMMSS</code> to order the execution of migrations added on the same day. Many older migrations filled the time component with <code>000000</code> but this can be ommitted now with the same effect.</p>
<h3 id="script-scope">Script scope</h3>
<p>Each migration is executed in a closed scope with three variables predefined:</p>
<ul>
<li><code>$migration</code>: An array containing the stored metadata about the transaction</li>
<li><code>$migrationNode</code>: A <code>SiteFile</code> instance for the current script being executed</li>
<li><code>$resetMigrationStatus</code>: A <code>callable</code> you can execute to delete the stored status for the current migration (useful while debugging, see below)</li>
</ul>
<p>Additionally, the migration runs in the scope of a member of the <code>Emergence\SiteAdmin\MigrationsRequestHandler</code> class and has access to a number of protected static methods it provides:</p>
<ul>
<li><code>static::tableExists($tableName)</code></li>
<li><code>static::columnExists($tableName, $columnName)</code></li>
<li><code>static::getColumns($tableName)</code></li>
<li><code>static::getColumnNames($tableName)</code></li>
<li><code>static::getColumn($tableName, $columnName)</code></li>
<li><code>static::getColumnType($tableName, $columnName)</code></li>
<li><code>static::getColumnKey($tableName, $columnName)</code></li>
<li><code>static::getColumnDefault($tableName, $columnName)</code></li>
<li><code>static::getColumnIsNullable($tableName, $columnName)</code></li>
<li><code>static::getConstraints($tableName)</code></li>
<li><code>static::getConstraint($tableName, $constraintName)</code></li>
<li><code>static::addColumn($tableName, $columnName, $definition, $position = null)</code></li>
<li><code>static::addIndex($tableName, $indexName, array $columns = [], $type = null)</code></li>
<li><code>static::dropColumn($tableName, $columnName)</code></li>
</ul>
<p>All output is captured and reported on after a migration is executed but not (currently) saved.</p>
<h3 id="debugging">Debugging</h3>
<p>The best workflow for debugging a migration is to dump and reload all application tables (including <code>_e_migrations</code> but excluding <code>_e_file*</code> VFS tables if present) between each execution.</p>
<p>During the development though, you might find it helpful to call <code>$resetMigrationStatus()</code> at the beggining of your script or <code>return static::STATUS_DEBUG</code> to erase the <code>_e_migrations</code> record that would prevent you from running it over and over again.</p>
<h2 id="example-migrations">Example migrations</h2>
<h3 id="add-a-column">Add a column</h3>
<p>This migration from <code>slate-cbl</code> is about as simple as it gets:</p>
<pre><code class="lang-php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title">Slate</span>\<span class="hljs-title">CBL</span>\<span class="hljs-title">Tasks</span>;


<span class="hljs-comment">// skip if Task table does not exist or already has ClonedTaskID</span>
<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">static</span>::tableExists(Task::$tableName)) {
    printf(<span class="hljs-string">&quot;Skipping migration because table `%s` does not yet exist\n&quot;</span>, Task::$tableName);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">static</span>::STATUS_SKIPPED;
}

<span class="hljs-keyword">if</span> (<span class="hljs-keyword">static</span>::columnExists(Task::$tableName, <span class="hljs-string">&apos;ClonedTaskID&apos;</span>)) {
    printf(<span class="hljs-string">&quot;Skipping migration because column `%s`.`ClonedTaskID` already exists\n&quot;</span>, Task::$tableName);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">static</span>::STATUS_SKIPPED;
}


<span class="hljs-comment">// add ClonedTaskID column to Task table</span>
<span class="hljs-keyword">static</span>::addColumn(Task::$tableName, <span class="hljs-string">&apos;ClonedTaskID&apos;</span>, <span class="hljs-string">&apos;int unsigned NULL default NULL&apos;</span>, <span class="hljs-string">&apos;AFTER `ParentTaskID`&apos;</span>);


<span class="hljs-comment">// finish</span>
<span class="hljs-keyword">return</span> <span class="hljs-keyword">static</span>::STATUS_EXECUTED;
</code></pre>
<h3 id="move-column-to-parent-record">Move column to parent record</h3>
<p>This migration, also from <code>slate-cbl</code>, is about as complex as it gets:</p>
<pre><code class="lang-php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title">Slate</span>\<span class="hljs-title">CBL</span>\<span class="hljs-title">Tasks</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">DB</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">HandleBehavior</span>;


<span class="hljs-comment">// skip if Task table does not exist or already has SectionID</span>
<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">static</span>::tableExists(Task::$tableName)) {
    printf(<span class="hljs-string">&quot;Skipping migration because table `%s` does not yet exist\n&quot;</span>, Task::$tableName);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">static</span>::STATUS_SKIPPED;
}

<span class="hljs-keyword">if</span> (<span class="hljs-keyword">static</span>::columnExists(Task::$tableName, <span class="hljs-string">&apos;SectionID&apos;</span>)) {
    printf(<span class="hljs-string">&quot;Skipping migration because column `%s`.`SectionID` already exists\n&quot;</span>, Task::$tableName);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">static</span>::STATUS_SKIPPED;
}


<span class="hljs-comment">// find existing SectionIDs for all associated StudentTask records, clone Task records as needed</span>
$taskColumnNames = array_diff(<span class="hljs-keyword">static</span>::getColumnNames(Task::$tableName), [<span class="hljs-string">&apos;ID&apos;</span>, <span class="hljs-string">&apos;Handle&apos;</span>]);
$taskSectionIds = DB::arrayTable(<span class="hljs-string">&apos;TaskID&apos;</span>, <span class="hljs-string">&apos;SELECT DISTINCT TaskID, SectionID FROM `%s`&apos;</span>, StudentTask::$tableName);
$taskSectionId = [];

<span class="hljs-keyword">foreach</span> ($taskSectionIds <span class="hljs-keyword">as</span> $taskId =&gt; $studentTaskSections) {
    <span class="hljs-comment">// original task gets first section</span>
    <span class="hljs-keyword">if</span> ($studentTaskSection = array_shift($studentTaskSections)) {
        $taskSectionId[$taskId] = $studentTaskSection[<span class="hljs-string">&apos;SectionID&apos;</span>];
    }

    <span class="hljs-comment">// no cloning is needed</span>
    <span class="hljs-keyword">if</span> (count($studentTaskSections) == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">continue</span>;
    }

    $taskTitle = DB::oneValue(<span class="hljs-string">&apos;SELECT Title FROM `%s` WHERE ID = %u&apos;</span>, [Task::$tableName, $taskId]);

    <span class="hljs-comment">// clone for any/each additional section</span>
    <span class="hljs-keyword">while</span> ($studentTaskSection = array_shift($studentTaskSections)) {
        $cloneHandle = HandleBehavior::getUniqueHandle(Task::class, $taskTitle);
        DB::nonQuery(
            <span class="hljs-string">&apos;INSERT INTO `%1$s` (`ID`, `Handle`, `%4$s`) SELECT NULL, &quot;%3$s&quot;, `%4$s` FROM `%1$s` WHERE ID = %2$u&apos;</span>,
            [
                Task::$tableName,
                $taskId,
                DB::escape($cloneHandle),
                implode(<span class="hljs-string">&apos;`, `&apos;</span>, $taskColumnNames)
            ]
        );

        $taskSectionId[DB::insertID()] = $studentTaskSection[<span class="hljs-string">&apos;SectionID&apos;</span>];
        printf(<span class="hljs-string">&quot;Cloning task %u for section %u\n&quot;</span>, $taskId, $studentTaskSection[<span class="hljs-string">&apos;SectionID&apos;</span>]);
    }
}


<span class="hljs-comment">// add SectionID column to Task table</span>
<span class="hljs-keyword">static</span>::addColumn(Task::$tableName, <span class="hljs-string">&apos;SectionID&apos;</span>, <span class="hljs-string">&apos;int unsigned NULL default NULL&apos;</span>, <span class="hljs-string">&apos;AFTER `ModifierID`&apos;</span>);
<span class="hljs-keyword">static</span>::addIndex(Task::$tableName, <span class="hljs-string">&apos;SectionID&apos;</span>);


<span class="hljs-comment">// clone Task for each SectionID where multiple are associated</span>
printf(<span class="hljs-string">&quot;Setting SectionID for %u Task records\n&quot;</span>, count($taskSectionId));
<span class="hljs-keyword">foreach</span> ($taskSectionId <span class="hljs-keyword">as</span> $taskId =&gt; $sectionId) {
    DB::nonQuery(<span class="hljs-string">&apos;UPDATE `%s` SET SectionID = %u WHERE ID = %u&apos;</span>, [
        Task::$tableName,
        $sectionId,
        $taskId
    ]);
}


<span class="hljs-comment">// remove SectionID column from StudentTask table</span>
<span class="hljs-keyword">static</span>::dropColumn(StudentTask::$tableName, <span class="hljs-string">&apos;SectionID&apos;</span>);


<span class="hljs-comment">// finish</span>
<span class="hljs-keyword">return</span> <span class="hljs-keyword">static</span>::STATUS_EXECUTED;
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="make-a-model-searchable-by-tags.html" class="navigation navigation-prev " aria-label="Previous page: Make a Model Searchable by Tags">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="skeletons-from-scratch.html" class="navigation navigation-next " aria-label="Next page: Bootstrap a Site from Git">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Migrations","level":"1.4.3","depth":2,"next":{"title":"Bootstrap a Site from Git","level":"1.4.4","depth":2,"path":"guides/skeletons-from-scratch.md","ref":"guides/skeletons-from-scratch.md","articles":[]},"previous":{"title":"Make a Model Searchable by Tags","level":"1.4.2","depth":2,"path":"guides/make-a-model-searchable-by-tags.md","ref":"guides/make-a-model-searchable-by-tags.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"guides/migrations.md","mtime":"2019-10-28T18:23:09.748Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-10-28T18:23:12.028Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

